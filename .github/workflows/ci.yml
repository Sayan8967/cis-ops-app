name: CI/CD Pipeline

on:
  push:
    branches: [release]
  pull_request:
    branches: [release]

env:
  DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
  BACKEND_IMAGE: cis-ops-backend
  FRONTEND_IMAGE: cis-ops-frontend

jobs:
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci
      - name: Build backend
        working-directory: ./backend
        run: npm run build --if-present

  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          REACT_APP_HF_API_KEY: ${{ secrets.REACT_APP_HF_API_KEY }}
          REACT_APP_GOOGLE_CLIENT_ID: ${{ secrets.REACT_APP_GOOGLE_CLIENT_ID }}

  docker-backend:
    needs: build-backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_KEY }}
      - name: Build and push backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  docker-frontend:
    needs: build-frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_KEY }}
      - name: Build and push frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:latest
          build-args: |
            REACT_APP_HF_API_KEY=${{ secrets.REACT_APP_HF_API_KEY }}
            REACT_APP_GOOGLE_CLIENT_ID=${{ secrets.REACT_APP_GOOGLE_CLIENT_ID }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  trivy-scan-backend:
    needs: docker-backend
    runs-on: ubuntu-latest
    steps:
      - name: Run Trivy vulnerability scanner (Backend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-backend-results.sarif'

  trivy-scan-frontend:
    needs: docker-frontend
    runs-on: ubuntu-latest
    steps:
      - name: Run Trivy vulnerability scanner (Frontend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-frontend-results.sarif'

  update-manifests:
    needs: [trivy-scan-backend, trivy-scan-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Create deployment directory
        run: mkdir -p k8s/manifests
      
      - name: Update or Create Kubernetes manifests
        run: |
          # Show what we're working with for debugging
          echo "Current directory: $(pwd)"
          echo "Creating k8s/manifests directory..."
          
          # Create namespace if it doesn't exist
          echo "Creating namespace.yaml..."
          cat > k8s/manifests/namespace.yaml << 'EOF'
          apiVersion: v1
          kind: Namespace
          metadata:
            name: cis-ops
            labels:
              name: cis-ops
              app.kubernetes.io/name: cis-ops
              app.kubernetes.io/managed-by: argocd
          EOF

          # Update backend deployment with new image or create if it doesn't exist
          if [ -f "k8s/manifests/backend-deployment.yaml" ]; then
            echo "Updating existing backend deployment..."
            sed -i "s|image:.*cis-ops-backend.*|image: ${{ env.DOCKER_REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}|g" k8s/manifests/backend-deployment.yaml
          else
            echo "Creating new backend deployment..."
            cat > k8s/manifests/backend-deployment.yaml << 'EOF'
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: cis-ops-backend
            namespace: cis-ops
            labels:
              app: cis-ops-backend
              app.kubernetes.io/name: cis-ops
              app.kubernetes.io/component: backend
              app.kubernetes.io/managed-by: argocd
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: cis-ops-backend
            template:
              metadata:
                labels:
                  app: cis-ops-backend
                  app.kubernetes.io/name: cis-ops
                  app.kubernetes.io/component: backend
              spec:
                containers:
                - name: backend
                  image: BACKEND_IMAGE_PLACEHOLDER
                  ports:
                  - containerPort: 4000
                    name: http
                  env:
                  - name: NODE_ENV
                    value: "production"
                  - name: PORT
                    value: "4000"
                  - name: CORS_ORIGIN
                    value: "*"
                  resources:
                    requests:
                      memory: "128Mi"
                      cpu: "100m"
                    limits:
                      memory: "512Mi"
                      cpu: "500m"
                  livenessProbe:
                    httpGet:
                      path: /api/health
                      port: 4000
                    initialDelaySeconds: 30
                    periodSeconds: 10
                  readinessProbe:
                    httpGet:
                      path: /api/health
                      port: 4000
                    initialDelaySeconds: 5
                    periodSeconds: 5
          EOF
            echo "Replacing backend image placeholder..."
            sed -i "s|BACKEND_IMAGE_PLACEHOLDER|${{ env.DOCKER_REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}|g" k8s/manifests/backend-deployment.yaml
          fi
          
          # Update frontend deployment with new image or create if it doesn't exist
          if [ -f "k8s/manifests/frontend-deployment.yaml" ]; then
            echo "Updating existing frontend deployment..."
            sed -i "s|image:.*cis-ops-frontend.*|image: ${{ env.DOCKER_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}|g" k8s/manifests/frontend-deployment.yaml
          else
            echo "Creating new frontend deployment..."
            cat > k8s/manifests/frontend-deployment.yaml << 'EOF'
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: cis-ops-frontend
            namespace: cis-ops
            labels:
              app: cis-ops-frontend
              app.kubernetes.io/name: cis-ops
              app.kubernetes.io/component: frontend
              app.kubernetes.io/managed-by: argocd
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: cis-ops-frontend
            template:
              metadata:
                labels:
                  app: cis-ops-frontend
                  app.kubernetes.io/name: cis-ops
                  app.kubernetes.io/component: frontend
              spec:
                containers:
                - name: frontend
                  image: FRONTEND_IMAGE_PLACEHOLDER
                  ports:
                  - containerPort: 80
                    name: http
                  resources:
                    requests:
                      memory: "64Mi"
                      cpu: "50m"
                    limits:
                      memory: "256Mi"
                      cpu: "200m"
                  livenessProbe:
                    httpGet:
                      path: /
                      port: 80
                    initialDelaySeconds: 30
                    periodSeconds: 10
                  readinessProbe:
                    httpGet:
                      path: /
                      port: 80
                    initialDelaySeconds: 5
                    periodSeconds: 5
          EOF
            echo "Replacing frontend image placeholder..."
            sed -i "s|FRONTEND_IMAGE_PLACEHOLDER|${{ env.DOCKER_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}|g" k8s/manifests/frontend-deployment.yaml
          fi

          # Create backend service
          echo "Creating backend service..."
          cat > k8s/manifests/backend-service.yaml << 'EOF'
          apiVersion: v1
          kind: Service
          metadata:
            name: cis-ops-backend-service
            namespace: cis-ops
            labels:
              app: cis-ops-backend
              app.kubernetes.io/name: cis-ops
              app.kubernetes.io/component: backend
              app.kubernetes.io/managed-by: argocd
          spec:
            type: NodePort
            selector:
              app: cis-ops-backend
            ports:
            - name: http
              port: 4000
              targetPort: 4000
              nodePort: 30400
              protocol: TCP
          EOF

          # Create frontend service
          echo "Creating frontend service..."
          cat > k8s/manifests/frontend-service.yaml << 'EOF'
          apiVersion: v1
          kind: Service
          metadata:
            name: cis-ops-frontend-service
            namespace: cis-ops
            labels:
              app: cis-ops-frontend
              app.kubernetes.io/name: cis-ops
              app.kubernetes.io/component: frontend
              app.kubernetes.io/managed-by: argocd
          spec:
            type: NodePort
            selector:
              app: cis-ops-frontend
            ports:
            - name: http
              port: 80
              targetPort: 80
              nodePort: 30080
              protocol: TCP
          EOF

          # Create ArgoCD application
          echo "Creating ArgoCD application..."
          cat > k8s/argocd-application.yaml << 'EOF'
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: cis-ops
            namespace: argocd
            finalizers:
            - resources-finalizer.argocd.argoproj.io
          spec:
            project: default
            source:
              repoURL: REPO_URL_PLACEHOLDER
              targetRevision: BRANCH_PLACEHOLDER
              path: k8s/manifests
            destination:
              server: https://kubernetes.default.svc
              namespace: cis-ops
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
                allowEmpty: false
              syncOptions:
              - CreateNamespace=true
          EOF
          echo "Replacing ArgoCD placeholders..."
          sed -i "s|REPO_URL_PLACEHOLDER|${{ github.server_url }}/${{ github.repository }}|g" k8s/argocd-application.yaml
          sed -i "s|BRANCH_PLACEHOLDER|${{ github.ref_name }}|g" k8s/argocd-application.yaml
          
          # Show what we created
          echo "Files created:"
          ls -la k8s/manifests/
          ls -la k8s/
          
          echo "Content verification:"
          echo "=== Backend Deployment ==="
          head -10 k8s/manifests/backend-deployment.yaml
          echo "=== Frontend Deployment ==="
          head -10 k8s/manifests/frontend-deployment.yaml

      - name: Check for changes and commit
        run: |
          # Show current directory and files for debugging
          echo "Current directory: $(pwd)"
          echo "Files in k8s/manifests/:"
          ls -la k8s/manifests/ || echo "k8s/manifests/ doesn't exist"
          
          # Show git status for debugging
          echo "Git status:"
          git status
          
          # Add all files in k8s directory
          git add k8s/
          
          # Check if there are staged changes
          if git diff --staged --quiet; then
            echo "No changes detected in manifests"
            echo "Git diff output:"
            git diff --staged
          else
            echo "Changes detected, committing updates..."
            echo "Staged changes:"
            git diff --staged --name-only
            
            git commit -m "ðŸš€ Update deployment images to ${{ github.sha }}"
            
            # Use a retry mechanism for push in case of conflicts
            for i in {1..3}; do
              if git push origin ${{ github.ref_name }}; then
                echo "Successfully pushed changes"
                break
              else
                echo "Push failed, attempt $i/3. Pulling latest changes..."
                git pull --rebase origin ${{ github.ref_name }}
                if [ $i -eq 3 ]; then
                  echo "Failed to push after 3 attempts"
                  exit 1
                fi
              fi
            done
          fi

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "### Updated Images:" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`${{ env.DOCKER_REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`${{ env.DOCKER_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "### ArgoCD Sync:" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD will automatically detect and sync these changes." >> $GITHUB_STEP_SUMMARY
          echo "### Manual Commands:" >> $GITHUB_STEP_SUMMARY
          echo "\`kubectl apply -f k8s/manifests/\`" >> $GITHUB_STEP_SUMMARY
          echo "### Services:" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: NodePort on localhost:30080" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: NodePort on localhost:30400" >> $GITHUB_STEP_SUMMARY